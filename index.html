<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Escaping in Rails 3</title>
    <meta name="author" content="Greg Hurrell">
    <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic'
          rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="reveal/css/reset.css">
    <link rel="stylesheet" href="reveal/css/main.css">
    <link rel="stylesheet" href="highlight/styles/solarized_dark.css">

    <!-- overrides for default reveal styles -->
    <style type="text/css">
      #reveal pre {
        font-size: 24px;
      }
    </style>
  </head>
  <body>
    <div id="reveal">
      <div class="slides">
        <section>
          <h1>View escaping in Rails 3</h1>
        </section>

        <section>
          <h2>Escaping is on by default</h2>
          <ul>
            <li class="fragment">
              You no longer need to use <code>h</code> to escape untrusted
              input
            <li class="fragment">
              Everything is untrusted by default, and Rails will automatically
              escape it
              <pre class="fragment"><code class="language-ruby" contenteditable>
# the Rails 2.x way:
&lt;%= h @cause.name %&gt;

# the Rails 3.x way:
&lt;%= @cause.name %&gt;
              </code></pre>
            <li class="fragment">
              This is a security win because blacklisting is easy to get wrong;
              with whitelisting, you can still make mistakes but they're less
              likely to be security holes
          </ul>
        </section>

        <section>
          <h2>"HTML-safe" strings</h2>
          <ul>
            <li class="fragment">
              Internally Rails keeps track of whether or not a string is
              "HTML-safe"
            <li class="fragment">
              User input (and infact any string not explicitly marked as
              trustworthy) is <em>not</em> considered safe
              <pre><code class="language-ruby">
"foo".html_safe? # =&gt; false
              </code></pre>
          </ul>
        </section>

        <section>
          <h2>Rails helpers</h2>
          <ul>
            <li class="fragment">
              HTML generated by Rails helper methods like <code>link_to</code>
              is marked as HTML-safe
              <pre><code class="language-ruby" contenteditable>
str = link_to 'start', new_cause_url
str.html_safe? # =&gt; true
              </code></pre>
          </ul>
        </section>

        <section>
          <h2>Marking content as safe</h2>
          <ul>
            <li class="fragment">
              You can mark a string you know to be safe using
              <code>html_safe</code>:
              <pre><code class="language-ruby" contenteditable>
str = "&lt;em&gt;I'm safe!&lt;/em&gt;".html_safe
str.html_safe? # =&gt; true
              </code></pre>
            <li class="fragment">
              You can also output unsafe strings without escaping using the
              <code>raw</code> helper:
              <pre><code class="language-ruby" contenteditable>
&lt;%=
  str = "&lt;em&gt;I contain raw HTML&lt;/em&gt;"
  str.html_safe? # =&gt; false
  raw(str) # the HTML will be inserted without escaping
%&gt;
              </code></pre>
          </ul>
        </section>

        <section>
          <h2>Appending: safe + unsafe</h2>
          <ul>
            <li class="fragment">
             Appending to an HTML-safe string automatically escapes the
              appended content
            <li class="fragment">
              The resulting string is still considered HTML-safe
              <pre><code class="language-ruby" contenteditable>
str = 'trusted content'.html_safe
str.html_safe? # =&gt; true
str += "&lt;em&gt;untrusted&lt;/em&gt;"
str.html_safe? # =&gt; true
str # => "trusted content&amp;lt;em&amp;gt;untrusted&amp;lt;/em&amp;gt;"
    # string won't be escaped when rendered
              </code></pre>
          </ul>
        </section>

        <section>
          <h2>Appending: unsafe + safe</h2>
          <ul>
            <li class="fragment">
              Appending HTML-safe content to an unsafe string produces an unsafe
              result
              <pre><code class="language-ruby" contenteditable>
str = 'not trusted'
str.html_safe? # =&gt; false
str += "&lt;em&gt;trusted&lt;/em&gt;".html_safe
str.html_safe? # =&gt; false
str # => "not trusted&lt;em&gt;trusted&lt;/em&gt;"
    # entire string will be escaped when rendered
            </code></pre>
          </ul>
        </section>

        <section>
          <h2>Appending: overview</h2>
          <pre><code class="language-ruby" contenteditable>
&gt; safe = '&lt;em&gt;foo&lt;/em&gt;'.html_safe
=&gt; "&lt;em&gt;foo&lt;/em&gt;"
&gt; unsafe = '&lt;strong&gt;bar&lt;/strong&gt;'
=&gt; "&lt;strong&gt;bar&lt;/strong&gt;"
&gt; (safe + unsafe)
=&gt; "&lt;em&gt;foo&lt;/em&gt;&amp;lt;strong&amp;gt;bar&amp;lt;/strong&amp;gt;"
&gt; (safe + unsafe).html_safe?
=&gt; true
&gt; (unsafe + safe)
=&gt; "&lt;strong&gt;bar&lt;/strong&gt;&lt;em&gt;foo&lt;/em&gt;"
&gt; (unsafe + safe).html_safe?
=&gt; false
          </code></pre>
        </section>

        <section>
          <h2>A real-world example</h2>
          <pre><code class="language-ruby" contenteditable>
def breadcrumbs *crumbs
  content_tag :div, :id => 'breadcrumbs' do
    [link_to('Home', root_path), *crumbs].map do |crumb|
      crumb.html_safe? ? crumb : h(crumb)
    end.join(' &amp;raquo; ').html_safe
  end
end
          </code></pre>
          <img src="breadcrumbs.png"
               title="Breadcrumbs on wincent.com forums">
        </section>

        <section>
          <h2>Observations</h2>
          <ul>
            <li>Rails' <code>content_tag</code> returns an HTML-safe string
            <li><code>link_to</code> returns an HTML-safe string
            <li>Individual "crumbs" may safe or unsafe; note how even in Rails 3
              there are still occasions where it's necessary to use
              <code>h</code>
            <li>Joining safe strings makes them unsafe
            <li>HTML-entities will get escaped unless they're in safe strings
            <li>Helpers we write should return HTML-safe strings
          </ul>
        </section>
      </div>

      <!-- required for correct operation of reveal.js,
           even if we don't want controls -->
      <aside class="controls">
        <a class="left" href="#">&#x25c4;</a>
        <a class="right" href="#">&#x25ba;</a>
        <a class="up" href="#">&#x25b2;</a>
        <a class="down" href="#">&#x25bc;</a>
      </aside>

    </div>
    <script src="reveal/js/reveal.js"></script>
    <script src="highlight/highlight.pack.js"></script>
    <script>
      Reveal.initialize({
        controls: false,
        progress: false,
        history: true,
        mouseWheel: false,
        rollingLinks: false,
      });
      hljs.initHighlightingOnLoad();
    </script>
